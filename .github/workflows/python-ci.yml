# 游늭 .github/workflows/python-ci.yml
# 游냀 Pipeline CI para pruebas automatizadas de Selenium en ambiente controlado

name: 游냀 Python CI - Suite de Automatizaci칩n QA

on:
  # 游뚽 Dispara el workflow en eventos de push y pull_request
  push:
    branches:
      - main
      - develop  # Incluye ramas de desarrollo si se usan
  pull_request:
    branches:
      - main
      - develop  # Revisi칩n autom치tica de PRs en ramas clave como desarrollo 

jobs:
  run_tests_job:
    name: Ejecutar Pruebas Automatizadas
    runs-on: ubuntu-latest  # Usa el runner hospedado m치s reciente de GitHub

    # 丘뙖잺 Variables de entorno para configurar Selenium o acceso a servicios
    env:
      BROWSER_HEADLESS: true  # Para ejecutar en modo headless sin UI
      # GOOGLE_API_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
      # TEST_APP_URL: https://www.ejemplo.com  # URL configurable si aplica

    steps:
      # 游닌 Clona el repositorio en el runner
      - name: 拘勇 Clonar el repositorio
        uses: actions/checkout@v4

      # 游빔 Instala dependencias del sistema necesarias para navegador
      - name: 游댢 Instalar dependencias del sistema (Ubuntu 24.04)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            chromium-browser \            # Navegador base para Selenium
            libnss3 \                     # Librer칤as de compatibilidad
            libxss1 \                     # Requerida por Chromium
            libasound2t64 \               # Correcci칩n clave para evitar errores
            xvfb                          # Virtual framebuffer (headless gr치fico opcional)

      # 游냀 Configura Python en el runner con la versi칩n deseada
      - name: 游냀 Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # Puedes cambiar si el proyecto requiere otra version

      # 游닍 Instala dependencias del proyecto desde archivos de requisitos
      - name: 游닍 Instalar dependencias de Python
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt -r dev-requirements.txt

      # 游댍 Verifica que los paquetes y carpetas necesarias est치n listos
      - name: 游댌 Validar entorno (paquetes y estructura)
        run: |
          python utils/check_env.py  # Script personalizado para QA pre-run

      # 游빍 Ejecuta las pruebas con reporte HTML y cobertura
      - name: 游빍 Ejecutar pruebas Pytest con HTML y cobertura
        run: |
          pytest \
            --html=reports/report.html \
            --self-contained-html \
            --cov=./tests

      # 游늵 Genera reporte de cobertura de c칩digo en formato HTML
      - name: 游늵 Generar reporte de cobertura HTML
        run: |
          coverage html -d reports/coverage_html  # Genera archivo 'index.html' de cobertura

      # 游닋 Publica todos los reportes como artefactos en GitHub Actions
      - name: 游닋 Publicar reportes como artefactos
        uses: actions/upload-artifact@v4
        with:
          name: Reportes-QA-Automatizacion  # Nombre del bundle de reportes
          path: reports/                    # Incluye HTML, cobertura y otros archivos
          retention-days: 7                 # Opcional: cu치nto tiempo mantenerlos disponibles